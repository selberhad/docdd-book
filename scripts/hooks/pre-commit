#!/usr/bin/env bash
# Pre-commit hook: build the mdBook, run linkcheck, and update stats
set -euo pipefail

echo "[pre-commit] Running 'make check' (mdbook build + linkcheck)..."

if ! command -v mdbook >/dev/null 2>&1; then
  echo "[pre-commit] mdbook not found. Run 'make setup' first." >&2
  exit 1
fi

make check

echo "[pre-commit] Generating STATS.md..."
python3 scripts/book_stats.py --markdown > STATS.md

# Add STATS.md to the commit if it changed
if git diff --quiet STATS.md 2>/dev/null; then
  echo "[pre-commit] STATS.md unchanged."
else
  echo "[pre-commit] STATS.md updated, adding to commit."
  git add STATS.md
fi

echo "[pre-commit] OK â€” build, linkcheck, and stats update completed."
